<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>时光纽带</title>
    <style>
/* 时光纽带 - 天空与阳光的交响 */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

:root {
    /* 天空色系 - 从晨曦到日落 */
    --dawn-blue: #E6F3FF;
    --morning-blue: #B8E0FF;
    --sky-blue: #87CEEB;
    --deep-sky: #4A90E2;
    --sunset-gold: #FFD700;
    --sunset-orange: #FFA500;
    --dusk-purple: #9B59B6;
    
    /* 光效 */
    --light-glow: rgba(255, 255, 255, 0.8);
    --soft-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    --glass-blur: blur(20px);
    --light-blur: blur(40px);
    
    /* 时间 */
    --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
    --transition-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
    overflow-x: hidden;
    background: linear-gradient(180deg, var(--dawn-blue) 0%, var(--morning-blue) 100%);
    min-height: 100vh;
    position: relative;
}

/* 开场 - 晨光 */
.dawn-screen {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: dawnFadeOut 3s ease forwards;
    animation-delay: 2s;
}

.dawn-gradient {
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at center, 
        var(--dawn-blue) 0%, 
        var(--morning-blue) 50%, 
        var(--sky-blue) 100%);
    animation: skyBreathe 4s ease infinite;
}

.dawn-sun {
    width: 80px;
    height: 80px;
    background: radial-gradient(circle, var(--sunset-gold) 0%, var(--sunset-orange) 100%);
    border-radius: 50%;
    filter: blur(1px);
    animation: sunRise 3s ease;
    box-shadow: 0 0 60px var(--sunset-gold);
}

.dawn-title {
    font-size: 32px;
    font-weight: 200;
    letter-spacing: 4px;
    color: white;
    margin-top: 30px;
    text-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
}

.dawn-shimmer {
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.3) 50%, 
        transparent 100%);
    animation: shimmer 2s ease infinite;
}

/* 认证 - 天空之门 */
.auth-flow {
    position: fixed;
    inset: 0;
    z-index: 900;
    display: flex;
    align-items: center;
    justify-content: center;
}

.auth-mist {
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at center, 
        rgba(135, 206, 235, 0.15) 0%, 
        rgba(255, 255, 255, 0.9) 100%);
    backdrop-filter: blur(40px);
}

.auth-portal {
    position: relative;
    padding: 80px;
}

.portal-glow {
    position: absolute;
    inset: -60px;
    background: radial-gradient(circle, 
        rgba(135, 206, 235, 0.2) 0%, 
        transparent 60%);
    filter: blur(100px);
    animation: portalPulse 4s ease infinite;
}

.auth-input {
    width: 220px;
    height: 64px;
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.8) 0%,
        rgba(135, 206, 235, 0.05) 100%);
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: 32px;
    text-align: center;
    font-size: 26px;
    font-weight: 200;
    letter-spacing: 14px;
    padding: 0 32px;
    backdrop-filter: blur(25px);
    box-shadow: 0 10px 40px rgba(135, 206, 235, 0.08);
    transition: all 0.4s var(--transition-smooth);
}

.auth-input:focus {
    outline: none;
    transform: scale(1.05);
    box-shadow: 0 8px 32px rgba(135, 206, 235, 0.3);
}

.auth-hint {
    text-align: center;
    margin-top: 24px;
    font-size: 13px;
    font-weight: 300;
    color: rgba(74, 144, 226, 0.5);
    letter-spacing: 1.5px;
    text-shadow: 0 1px 4px rgba(255, 255, 255, 0.8);
}

/* 时光河流 - 主体 */
.time-river {
    position: relative;
    width: 100%;
    min-height: 100vh;
}

/* 天空渐变背景 */
.sky-gradient {
    position: fixed;
    inset: 0;
    z-index: -1;
    overflow: hidden;
}

.sky-layer {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 2s ease;
}

.dawn-sky {
    background: linear-gradient(180deg, 
        var(--dawn-blue) 0%, 
        var(--morning-blue) 100%);
    opacity: 1;
}

.morning-sky {
    background: linear-gradient(180deg, 
        var(--morning-blue) 0%, 
        var(--sky-blue) 100%);
}

.noon-sky {
    background: linear-gradient(180deg, 
        var(--sky-blue) 0%, 
        var(--deep-sky) 100%);
}

.sunset-sky {
    background: linear-gradient(180deg, 
        var(--sunset-orange) 0%, 
        var(--dusk-purple) 100%);
}

/* 光晕流动 */
.light-streams {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1;
}

.light-stream {
    position: absolute;
    width: 200%;
    height: 200px;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.1) 50%, 
        transparent 100%);
    filter: var(--light-blur);
    animation: streamFlow 20s linear infinite;
}

.stream-1 {
    top: 20%;
    animation-duration: 25s;
}

.stream-2 {
    top: 50%;
    animation-duration: 30s;
    animation-delay: -10s;
}

.stream-3 {
    top: 80%;
    animation-duration: 35s;
    animation-delay: -20s;
}

/* 浮动时间标记 */
.time-marker {
    position: fixed;
    top: 25px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.85) 0%,
        rgba(135, 206, 235, 0.05) 100%);
    backdrop-filter: blur(30px);
    padding: 14px 28px;
    border-radius: 30px;
    box-shadow: 0 8px 35px rgba(135, 206, 235, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.6);
    transition: all 0.4s var(--transition-smooth);
}

.marker-names {
    font-size: 15px;
    font-weight: 400;
    color: var(--deep-sky);
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    text-shadow: 0 1px 3px rgba(255, 255, 255, 0.8);
}

.marker-heart {
    color: var(--sunset-gold);
    animation: heartBeat 2s ease infinite;
}

.marker-days {
    display: flex;
    align-items: baseline;
    gap: 6px;
    justify-content: center;
}

.marker-days #dayCount {
    font-size: 22px;
    font-weight: 500;
    color: var(--deep-sky);
    text-shadow: 0 1px 3px rgba(255, 255, 255, 0.8);
}

.days-label {
    font-size: 12px;
    font-weight: 400;
    color: rgba(74, 144, 226, 0.8);
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
}

/* 内容流 - 自由流淌 */
.content-flow {
    position: relative;
    padding: 120px 20px;
    z-index: 10;
}

.flow-section {
    position: relative;
    padding: 60px 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 40px 0;
}

.section-aura {
    position: absolute;
    inset: -80px;
    background: radial-gradient(ellipse at center, 
        rgba(255, 255, 255, 0.05) 0%, 
        transparent 50%);
    filter: blur(120px);
    pointer-events: none;
}

/* 流动过渡 - 无形连接 */
.flow-transition {
    height: 80px;
    position: relative;
    overflow: visible;
}

.transition-wave {
    width: 100%;
    height: 100%;
    opacity: 0.2;
}

.transition-blur {
    position: absolute;
    inset: -40px;
    background: radial-gradient(ellipse at center, 
        rgba(255, 215, 0, 0.05) 0%, 
        transparent 70%);
    filter: blur(100px);
}

.transition-sparkle {
    position: absolute;
    inset: 0;
    background-image: radial-gradient(circle, 
        rgba(255, 255, 255, 0.8) 1px, 
        transparent 1px);
    background-size: 20px 20px;
    animation: sparkle 10s linear infinite;
}

.transition-gradient {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.05) 50%, 
        transparent 100%);
}

/* 起源 - 时空之芯 */
.origin-content {
    text-align: center;
}

.origin-ring {
    position: relative;
    width: 100px;
    height: 100px;
    margin: 0 auto;
}

.ring-pulse {
    position: absolute;
    inset: 0;
    border: 1px solid rgba(135, 206, 235, 0.3);
    border-radius: 50%;
    animation: pulse 4s ease infinite;
}

.ring-date {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 17px;
    font-weight: 400;
    color: var(--deep-sky);
    letter-spacing: 1px;
    text-shadow: 0 2px 8px rgba(255, 255, 255, 0.9);
}

.origin-text {
    margin-top: 25px;
    font-size: 14px;
    font-weight: 400;
    color: rgba(74, 144, 226, 0.7);
    letter-spacing: 2px;
    text-shadow: 0 1px 4px rgba(255, 255, 255, 0.9);
}

/* 心情池 - 自然融合 */
.mood-pool {
    position: relative;
    width: 100%;
    max-width: 400px;
    padding: 20px;
}

.pool-surface {
    display: none; /* 移除背景容器 */
}

.mood-bubbles {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.mood-drop {
    width: 44px;
    height: 44px;
    border: none;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.8) 0%, 
        rgba(135, 206, 235, 0.1) 100%);
    backdrop-filter: blur(10px);
    border-radius: 50%;
    font-size: 22px;
    cursor: pointer;
    transition: all 0.4s var(--transition-bounce);
    box-shadow: 0 4px 15px rgba(135, 206, 235, 0.15);
}

.hug-drop {
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.8) 0%, 
        rgba(255, 215, 0, 0.1) 100%);
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.15);
}

.hug-drop:hover {
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.9) 0%, 
        rgba(255, 215, 0, 0.2) 100%);
    box-shadow: 0 8px 25px rgba(255, 215, 0, 0.25);
}

.mood-drop:hover {
    transform: translateY(-8px) scale(1.1);
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.9) 0%, 
        rgba(135, 206, 235, 0.3) 100%);
    box-shadow: 0 12px 25px rgba(135, 206, 235, 0.25);
}

.mood-input-container {
    position: relative;
    width: 100%;
    display: flex;
    align-items: center;
    gap: 10px;
}

.mood-input {
    flex: 1;
    background: transparent;
    border: none;
    border-bottom: 1px solid rgba(135, 206, 235, 0.2);
    text-align: center;
    font-size: 17px;
    font-weight: 400;
    color: var(--deep-sky);
    resize: none;
    height: 40px;
    padding: 10px;
    transition: all 0.3s ease;
    text-shadow: 0 1px 3px rgba(255, 255, 255, 0.8);
}

.mood-send-btn {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.8) 0%, 
        rgba(135, 206, 235, 0.1) 100%);
    backdrop-filter: blur(10px);
    border: none;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.4s var(--transition-bounce);
    box-shadow: 0 4px 15px rgba(135, 206, 235, 0.15);
}

.mood-send-btn:hover {
    transform: translateY(-2px) scale(1.05);
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.9) 0%, 
        rgba(135, 206, 235, 0.2) 100%);
    box-shadow: 0 6px 20px rgba(135, 206, 235, 0.25);
}

.mood-send-btn:active {
    transform: translateY(0) scale(0.95);
}

.mood-input::placeholder {
    color: rgba(135, 206, 235, 0.6);
    font-weight: 300;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
}

.mood-input:focus {
    outline: none;
    border-bottom-color: rgba(135, 206, 235, 0.5);
}

.mood-ripples {
    position: absolute;
    inset: -100px;
    pointer-events: none;
}

/* 小窝 - 真正无界 */
.home-nest {
    position: relative;
    width: 100vw;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0;
    margin: 0;
}

.nest-glow {
    display: none;
}

.nest-photo {
    position: relative;
    width: calc(100vw - 80px);
    max-width: 280px;
    aspect-ratio: 16/10;
    background: transparent;
    backdrop-filter: none;
    border-radius: 0;
    overflow: visible;
    cursor: pointer;
    transition: all 0.5s var(--transition-smooth);
    box-shadow: none;
    border: none;
}

.nest-photo:hover {
    transform: translateY(-5px);
    filter: brightness(1.1);
}

.photo-hint {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 15px;
    color: rgba(74, 144, 226, 0.8);
    text-shadow: 0 2px 12px rgba(255, 255, 255, 1);
    padding: 40px 20px;
}

.photo-hint span:last-child {
    font-size: 18px;
    font-weight: 300;
    letter-spacing: 2px;
    opacity: 0.9;
}

.hint-icon {
    font-size: 48px;
    filter: drop-shadow(0 4px 12px rgba(255, 255, 255, 0.8));
}

.nest-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.home-photo-delete {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    color: #ff4444;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 10;
    backdrop-filter: blur(10px);
}

.nest-photo:hover .home-photo-delete {
    opacity: 1;
}

.home-photo-delete:hover {
    background: #ff4444;
    color: white;
    transform: scale(1.1);
}

.nest-warmth {
    margin-top: 30px;
    font-size: 17px;
    font-weight: 300;
    color: var(--deep-sky);
    font-style: italic;
    opacity: 0.9;
    text-shadow: 0 3px 12px rgba(255, 255, 255, 1);
    letter-spacing: 1px;
    text-align: center;
    padding: 0 20px;
}

/* 下次见面 - 星光期待 */
.meeting-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 25px;
    max-width: 400px;
    padding: 20px;
}

.meeting-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 10px;
}

.meeting-emoji {
    font-size: 24px;
    animation: starTwinkle 2s ease-in-out infinite;
    filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.6));
}

.meeting-emoji:nth-child(3) {
    animation-delay: 0.5s;
}

.meeting-title {
    font-size: 22px;
    font-weight: 400;
    color: var(--deep-sky);
    text-shadow: 0 3px 15px rgba(255, 255, 255, 1);
    letter-spacing: 2px;
    margin: 0;
}

.meeting-countdown {
    position: relative;
    display: flex;
    justify-content: center;
}

.countdown-circle {
    position: relative;
    width: 200px;
    height: 200px;
}

.circle-glow {
    position: absolute;
    inset: -20px;
    background: radial-gradient(circle,
        rgba(255, 215, 0, 0.2) 0%,
        rgba(135, 206, 235, 0.1) 50%,
        transparent 80%);
    border-radius: 50%;
    filter: blur(30px);
    animation: meetingGlow 3s ease-in-out infinite;
}

.countdown-display {
    position: absolute;
    inset: 20px;
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.9) 0%,
        rgba(135, 206, 235, 0.1) 100%);
    backdrop-filter: blur(25px);
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 
        0 15px 50px rgba(135, 206, 235, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    border: 2px solid rgba(255, 255, 255, 0.6);
}

.count-number {
    font-size: 48px;
    font-weight: 300;
    color: var(--deep-sky);
    text-shadow: 0 3px 12px rgba(255, 255, 255, 0.8);
    line-height: 1;
}

.count-unit {
    font-size: 16px;
    font-weight: 400;
    color: rgba(74, 144, 226, 0.8);
    text-shadow: 0 2px 8px rgba(255, 255, 255, 0.8);
    margin-top: 5px;
    letter-spacing: 2px;
}

.circle-particles {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: conic-gradient(
        from 0deg,
        transparent 0deg,
        rgba(255, 215, 0, 0.3) 60deg,
        transparent 120deg,
        rgba(135, 206, 235, 0.3) 180deg,
        transparent 240deg,
        rgba(255, 215, 0, 0.3) 300deg,
        transparent 360deg
    );
    animation: particleRotate 20s linear infinite;
    opacity: 0.6;
}

.meeting-date-picker {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.date-label {
    font-size: 14px;
    font-weight: 300;
    color: rgba(74, 144, 226, 0.7);
    text-shadow: 0 2px 8px rgba(255, 255, 255, 0.8);
    letter-spacing: 1px;
}

.meeting-date-input {
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.8) 0%,
        rgba(135, 206, 235, 0.1) 100%);
    border: 2px solid rgba(135, 206, 235, 0.2);
    border-radius: 12px;
    color: var(--deep-sky);
    font-size: 15px;
    font-weight: 400;
    cursor: pointer;
    padding: 10px 15px;
    text-align: center;
    backdrop-filter: blur(15px);
    transition: all 0.3s ease;
    box-shadow: 0 5px 20px rgba(135, 206, 235, 0.1);
}

.meeting-date-input:focus {
    outline: none;
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.9) 0%,
        rgba(135, 206, 235, 0.15) 100%);
    border-color: rgba(135, 206, 235, 0.4);
    transform: scale(1.05);
    box-shadow: 0 8px 30px rgba(135, 206, 235, 0.2);
}

.meeting-date-input:hover {
    border-color: rgba(135, 206, 235, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(135, 206, 235, 0.15);
}

.meeting-message {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 25px;
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.6) 0%,
        rgba(135, 206, 235, 0.05) 100%);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(135, 206, 235, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.4);
}

.message-heart {
    font-size: 16px;
    animation: heartFloat 2.5s ease-in-out infinite;
}

.message-heart:nth-child(3) {
    animation-delay: 0.8s;
}

.message-text {
    font-size: 15px;
    font-weight: 300;
    color: var(--deep-sky);
    font-style: italic;
    text-shadow: 0 2px 8px rgba(255, 255, 255, 0.8);
    letter-spacing: 1px;
}

/* 移除旧的date-picker样式，使用新的meeting-date-input */

/* 照片流 - 时光碎片 */
.photos-section {
    padding: 80px 0;
}

.photos-river {
    width: 100%;
    overflow: hidden;
}

.river-title {
    text-align: center;
    font-size: 18px;
    font-weight: 400;
    color: var(--deep-sky);
    margin-bottom: 40px;
    letter-spacing: 2px;
    opacity: 0.8;
    text-shadow: 0 2px 8px rgba(255, 255, 255, 0.8);
}

.photos-stream {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    padding: 40px 20px;
    max-width: 600px;
    margin: 0 auto;
}

.photos-stream::-webkit-scrollbar {
    width: 0;
}

.photo-item {
    width: 100%;
    aspect-ratio: 1;
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.4) 0%,
        rgba(135, 206, 235, 0.08) 100%);
    backdrop-filter: blur(25px);
    border-radius: 16px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.4s var(--transition-smooth);
    box-shadow: 0 8px 30px rgba(135, 206, 235, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.4);
    position: relative;
}

.photo-item::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg,
        transparent 0%,
        rgba(135, 206, 235, 0.1) 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.photo-item:hover::before {
    opacity: 1;
}

.photo-item {
    position: relative;
}

.photo-delete {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    color: #ff4444;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 10;
}

.photo-item:hover .photo-delete {
    opacity: 1;
}

.photo-delete:hover {
    background: #ff4444;
    color: white;
    transform: scale(1.1);
}

/* 移除旧的photo-add样式 */

/* 移除旧的photo-add::before样式 */

/* 移除旧的photo-add:hover::before样式 */

/* 移除旧的add-icon样式 */

.photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.photo-item:hover {
    transform: translateY(-12px) scale(1.08);
    box-shadow: 0 25px 60px rgba(135, 206, 235, 0.2);
}

/* 移除旧的photo-add:hover样式 */

/* 无尽延续 - 时光渐隐 */
.flow-infinite {
    position: relative;
    height: 350px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.infinite-fade {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, 
        transparent 0%,
        rgba(255, 255, 255, 0.1) 30%,
        rgba(135, 206, 235, 0.05) 70%,
        rgba(255, 255, 255, 0.9) 100%);
    filter: blur(1px);
}

.infinite-dots {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.infinite-dots span {
    width: 6px;
    height: 6px;
    background: var(--sky-blue);
    border-radius: 50%;
    animation: dotFloat 3s ease infinite;
}

.infinite-dots span:nth-child(2) {
    animation-delay: 0.3s;
}

.infinite-dots span:nth-child(3) {
    animation-delay: 0.6s;
}

.infinite-text {
    font-size: 13px;
    font-weight: 200;
    color: rgba(74, 144, 226, 0.3);
    letter-spacing: 3px;
    text-shadow: 0 2px 12px rgba(255, 255, 255, 0.8);
    opacity: 0.8;
}

/* 移除独立拥抱按钮样式 */

/* 拥抱波纹 */
.hug-wave {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1000;
}

.wave-circle {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100px;
    height: 100px;
    border: 2px solid var(--sky-blue);
    border-radius: 50%;
    animation: waveExpand 1.5s ease;
}

.wave-heart {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 60px;
    animation: heartPop 1.5s ease;
}

/* 照片查看器 */
.photo-viewer {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.viewer-fog {
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(30px);
}

.viewer-photo {
    position: relative;
    max-width: 90%;
    max-height: 90%;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
}

.viewer-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    box-shadow: var(--soft-shadow);
    transition: all 0.3s ease;
}

.viewer-close:hover {
    transform: rotate(90deg);
    background: rgba(255, 255, 255, 1);
}

/* 设置 */
.settings-float {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: var(--glass-blur);
    border: none;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    box-shadow: var(--soft-shadow);
    transition: all 0.3s ease;
    z-index: 100;
}

.settings-float:hover {
    transform: rotate(90deg);
}

.settings-panel {
    position: fixed;
    inset: 0;
    z-index: 900;
    display: flex;
    align-items: center;
    justify-content: center;
}

.settings-mist {
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: var(--glass-blur);
}

.settings-card {
    position: relative;
    background: white;
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    text-align: center;
}

.settings-card h3 {
    margin-bottom: 30px;
    color: var(--deep-sky);
    font-weight: 300;
    letter-spacing: 2px;
}

.setting-item {
    display: block;
    width: 200px;
    padding: 12px;
    margin: 10px 0;
    background: rgba(135, 206, 235, 0.1);
    border: none;
    border-radius: 10px;
    color: var(--deep-sky);
    cursor: pointer;
    transition: all 0.3s ease;
}

.setting-item:hover {
    background: rgba(135, 206, 235, 0.2);
    transform: translateX(5px);
}

/* 动画 */
@keyframes dawnFadeOut {
    to {
        opacity: 0;
        visibility: hidden;
    }
}

@keyframes skyBreathe {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

@keyframes sunRise {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

@keyframes shimmer {
    from { transform: translateX(-100%); }
    to { transform: translateX(200%); }
}

@keyframes portalPulse {
    0%, 100% { transform: scale(1); opacity: 0.2; }
    50% { transform: scale(1.05); opacity: 0.4; }
}

@keyframes streamFlow {
    from { transform: translateX(-50%); }
    to { transform: translateX(50%); }
}

@keyframes heartBeat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.3; }
    50% { transform: scale(1.05); opacity: 0.7; }
}

@keyframes sparkle {
    from { transform: translateY(0); }
    to { transform: translateY(-20px); }
}

@keyframes nestGlow {
    0%, 100% { opacity: 0.3; }
    50% { transform: scale(1.02); opacity: 0.6; }
}

@keyframes orbit {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

@keyframes dotFloat {
    0%, 100% { transform: translateY(0); opacity: 0.3; }
    50% { transform: translateY(-10px); opacity: 1; }
}

@keyframes waveExpand {
    from {
        width: 100px;
        height: 100px;
        opacity: 1;
    }
    to {
        width: 600px;
        height: 600px;
        opacity: 0;
    }
}

@keyframes heartPop {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
    50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
}

@keyframes starTwinkle {
    0%, 100% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.2); opacity: 1; }
}

@keyframes meetingGlow {
    0%, 100% { 
        transform: scale(1);
        opacity: 0.4;
    }
    50% { 
        transform: scale(1.1);
        opacity: 0.7;
    }
}

@keyframes particleRotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

@keyframes heartFloat {
    0%, 100% { 
        transform: translateY(0) scale(1);
        opacity: 0.8;
    }
    50% { 
        transform: translateY(-3px) scale(1.1);
        opacity: 1;
    }
}

/* 移动端优化 */
@media (max-width: 768px) {
    .time-marker {
        top: 15px;
        padding: 12px 24px;
    }
    
    .marker-names {
        font-size: 14px;
    }
    
    .marker-days #dayCount {
        font-size: 20px;
    }
    
    .mood-pool {
        width: 100%;
        max-width: 350px;
        padding: 10px;
    }
    
    .mood-bubbles {
        gap: 12px;
    }
    
    .mood-drop {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
    
    .mood-input-container {
        gap: 8px;
    }
    
    .mood-send-btn {
        width: 36px;
        height: 36px;
        font-size: 16px;
    }
    
    .home-nest {
        width: 100vw;
        padding: 0 20px;
    }
    
    .nest-photo {
        width: calc(100vw - 40px);
        max-width: 300px;
    }
    
    .photos-river {
        padding: 0 15px;
    }
    
    .photos-header {
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .river-title {
        font-size: 18px;
    }
    
    .photo-add-btn {
        padding: 12px 20px;
        border-radius: 20px;
        gap: 10px;
    }
    
    .add-btn-icon {
        font-size: 20px;
    }
    
    .add-btn-text {
        font-size: 14px;
    }
    
    .photos-grid {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
    }
    
    .flow-section {
        padding: 40px 10px;
    }
    
    .content-flow {
        padding: 80px 0;
    }
    
    .meeting-container {
        max-width: 100%;
        padding: 15px;
        gap: 20px;
    }
    
    .meeting-title {
        font-size: 20px;
    }
    
    .meeting-emoji {
        font-size: 20px;
    }
    
    .countdown-circle {
        width: 160px;
        height: 160px;
    }
    
    .count-number {
        font-size: 40px;
    }
    
    .count-unit {
        font-size: 14px;
    }
    
    .meeting-date-input {
        font-size: 14px;
        padding: 8px 12px;
    }
    
    .message-text {
        font-size: 14px;
    }
}

/* 工具类 */
.hidden {
    display: none !important;
}
</style>
</head>
<body>
    <!-- 开场 - 晨光初现 -->
    <div id="dawn" class="dawn-screen">
        <div class="dawn-gradient"></div>
        <div class="dawn-content">
            <div class="dawn-sun"></div>
            <h1 class="dawn-title">时光纽带</h1>
            <div class="dawn-shimmer"></div>
        </div>
    </div>

    <!-- 认证 - 轻柔入口 -->
    <div id="auth" class="auth-flow hidden">
        <div class="auth-mist"></div>
        <div class="auth-portal">
            <div class="portal-glow"></div>
            <input type="tel" id="authCode" class="auth-input" 
                   placeholder="····" maxlength="4" 
                   pattern="[0-9]*" inputmode="numeric">
            <div class="auth-hint">Enter the magic number</div>
        </div>
    </div>

    <!-- 时光河流 - 无尽流淌 -->
    <div id="timeRiver" class="time-river hidden">
        <!-- 天空渐变层 - 从晨曦到日落 -->
        <div class="sky-gradient">
            <div class="sky-layer dawn-sky"></div>
            <div class="sky-layer morning-sky"></div>
            <div class="sky-layer noon-sky"></div>
            <div class="sky-layer sunset-sky"></div>
        </div>

        <!-- 光晕流动 -->
        <div class="light-streams">
            <div class="light-stream stream-1"></div>
            <div class="light-stream stream-2"></div>
            <div class="light-stream stream-3"></div>
        </div>

        <!-- 浮动时间标记 -->
        <div class="time-marker">
            <div class="marker-names">
                <span id="name1">段淦元</span>
                <span class="marker-heart">♡</span>
                <span id="name2">张琳曼</span>
            </div>
            <div class="marker-days">
                <span id="dayCount">0</span>
                <span class="days-label">Days Together</span>
            </div>
        </div>

        <!-- 时光内容流 - 垂直连续 -->
        <div class="content-flow" id="contentFlow">
            <!-- 起源 - 故事开始 -->
            <section class="flow-section origin-section">
                <div class="section-aura"></div>
                <div class="origin-content">
                    <div class="origin-ring">
                        <div class="ring-pulse"></div>
                        <div class="ring-date" id="originDate">2024.04.13</div>
                    </div>
                    <p class="origin-text">Our Story Begins Here</p>
                </div>
            </section>

            <!-- 流动过渡 -->
            <div class="flow-transition">
                <svg viewBox="0 0 100 200" class="transition-wave">
                    <defs>
                        <linearGradient id="waveGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#87CEEB;stop-opacity:0.1" />
                            <stop offset="50%" style="stop-color:#FFD700;stop-opacity:0.2" />
                            <stop offset="100%" style="stop-color:#87CEEB;stop-opacity:0.1" />
                        </linearGradient>
                    </defs>
                    <path d="M0,0 Q50,50 0,100 T0,200" fill="url(#waveGradient)"/>
                </svg>
            </div>


            <!-- 小窝 -->
            <section class="flow-section home-section">
                <div class="section-aura"></div>
                <div class="home-nest">
                    <div class="nest-glow"></div>
                    <div class="nest-photo" id="homePhoto">
                        <input type="file" id="homeFile" accept="image/*" hidden>
                        <div class="photo-hint">
                            <span class="hint-icon">🏠</span>
                            <span>Our Home</span>
                        </div>
                        <img id="homeImg" class="nest-img hidden">
                        <button id="homePhotoDelete" class="home-photo-delete hidden">×</button>
                    </div>
                    <div class="nest-warmth">
                        <span id="dailyQuote">家是有你的地方</span>
                    </div>
                </div>
            </section>

            <!-- 流动过渡 -->
            <div class="flow-transition">
                <div class="transition-sparkle"></div>
            </div>

            <!-- 下次见面 -->
            <section class="flow-section meeting-section">
                <div class="section-aura"></div>
                <div class="meeting-container">
                    <div class="meeting-header">
                        <span class="meeting-emoji">🌟</span>
                        <h3 class="meeting-title">下次见面</h3>
                        <span class="meeting-emoji">🌟</span>
                    </div>
                    <div class="meeting-countdown">
                        <div class="countdown-circle">
                            <div class="circle-glow"></div>
                            <div class="countdown-display">
                                <div class="count-number" id="countDays">0</div>
                                <div class="count-unit">天</div>
                            </div>
                            <div class="circle-particles"></div>
                        </div>
                    </div>
                    <div class="meeting-date-picker">
                        <label class="date-label">选择期待的日子</label>
                        <input type="date" id="nextDate" class="meeting-date-input">
                    </div>
                    <div class="meeting-message" id="meetingMessage">
                        <span class="message-heart">💙</span>
                        <span class="message-text">每一天的等待都值得</span>
                        <span class="message-heart">💙</span>
                    </div>
                </div>
            </section>

            <!-- 流动过渡 -->
            <div class="flow-transition">
                <div class="transition-gradient"></div>
            </div>

            <!-- 时光碎片 -->
            <section class="flow-section photos-section">
                <div class="section-aura"></div>
                <div class="photos-river">
                    <div class="photos-header">
                        <div class="river-title">时光碎片</div>
                        <button class="photo-add-btn" id="photoAdd">
                            <input type="file" id="photoFile" accept="image/*" multiple hidden>
                            <span class="add-btn-icon">📸</span>
                            <span class="add-btn-text">添加美好瞬间</span>
                        </button>
                    </div>
                    <div class="photos-grid" id="photoStream">
                        <!-- 照片动态加载 -->
                    </div>
                </div>
            </section>

            <!-- 流动过渡 -->
            <div class="flow-transition">
                <div class="transition-blur"></div>
            </div>

            <!-- 心情涟漪 -->
            <section class="flow-section mood-section">
                <div class="section-aura"></div>
                <div class="mood-pool">
                    <div class="mood-bubbles">
                        <button class="mood-drop" data-mood="happy">😊</button>
                        <button class="mood-drop" data-mood="love">💙</button>
                        <button class="mood-drop" data-mood="miss">🌙</button>
                        <button class="mood-drop" data-mood="sunny">☀️</button>
                        <button class="mood-drop hug-drop" data-mood="hug">🤗</button>
                    </div>
                    <div class="mood-input-container">
                        <textarea id="moodText" class="mood-input" 
                                  placeholder="此刻想说..." maxlength="50"></textarea>
                        <button id="moodSend" class="mood-send-btn">💙</button>
                    </div>
                    <div class="mood-ripples" id="moodRipples"></div>
                </div>
            </section>

            <!-- 无尽延续 -->
            <div class="flow-infinite">
                <div class="infinite-fade"></div>
                <div class="infinite-dots">
                    <span></span><span></span><span></span>
                </div>
                <p class="infinite-text">时光还在继续...</p>
            </div>
        </div>

    </div>

    <!-- 拥抱动效 -->
    <div id="hugWave" class="hug-wave hidden">
        <div class="wave-circle"></div>
        <div class="wave-heart">💙</div>
    </div>

    <!-- 照片查看器 -->
    <div id="photoViewer" class="photo-viewer hidden">
        <div class="viewer-fog"></div>
        <img id="viewerImg" class="viewer-photo">
        <button id="viewerClose" class="viewer-close">×</button>
    </div>

    <!-- 设置面板 -->
    <button id="settingsBtn" class="settings-float">⚙</button>
    <div id="settingsPanel" class="settings-panel hidden">
        <div class="settings-mist"></div>
        <div class="settings-card">
            <h3>设置</h3>
            <button id="clearBtn" class="setting-item">清除数据</button>
            <button id="closeSettings" class="setting-item">关闭</button>
        </div>
    </div>

    
    <!-- 数据存储区 -->
    <div id="embeddedPhotosData" style="display:none;"></div>
    <div id="embeddedMoodsData" style="display:none;"></div>
    
    <script>
    // 时光纽带 - 天空与阳光的交响
class TimeFlow {
    constructor() {
        // 预设配置
        this.preset = {
            name1: '段淦元',
            name2: '张琳曼',
            anniversary: '2024-04-13',
            password: '1314'
        };
        
        this.config = {
            storageKey: 'time_flow_',
            maxPhotos: 100,
            maxPhotoSize: 2 * 1024 * 1024
        };
        
        this.db = null;
        this.currentMood = null;
        this.scrollPosition = 0;
        
        // 创建全局引用
        window.timeFlowInstance = this;
        
        this.init();
    }
    
    async init() {
        // 初始化数据库
        await this.initDatabase();
        
        // 开场动画后进入
        setTimeout(() => {
            document.getElementById('dawn').style.display = 'none';
            this.checkAuth();
        }, 3000);
        
        // 绑定事件
        this.bindEvents();
        
        // 初始化滚动效果
        this.initScrollEffects();
        
        // 初始化数据同步功能
        this.initDataSync();
    }
    
    // 初始化IndexedDB
    async initDatabase() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('TimeFlowDB', 1);
            
            request.onerror = () => reject('Database failed');
            
            request.onsuccess = (event) => {
                this.db = event.target.result;
                resolve();
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                // 照片存储
                if (!db.objectStoreNames.contains('photos')) {
                    const photoStore = db.createObjectStore('photos', {
                        keyPath: 'id',
                        autoIncrement: true
                    });
                    photoStore.createIndex('date', 'date', { unique: false });
                }
                
                // 心情存储
                if (!db.objectStoreNames.contains('moods')) {
                    const moodStore = db.createObjectStore('moods', {
                        keyPath: 'id',
                        autoIncrement: true
                    });
                    moodStore.createIndex('date', 'date', { unique: false });
                }
            };
        });
    }
    
    // 绑定事件
    bindEvents() {
        // 认证
        const authInput = document.getElementById('authCode');
        if (authInput) {
            authInput.addEventListener('input', (e) => this.handleAuth(e));
        }
        
        // 心情
        document.querySelectorAll('.mood-drop').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.currentMood = e.target.dataset.mood;
                this.animateMoodDrop(e.target);
                
                // 如果是拥抱，触发拥抱动画
                if (e.target.dataset.mood === 'hug') {
                    this.sendHug();
                }
            });
        });
        
        document.getElementById('moodText')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.saveMood();
            }
        });
        
        // 心情发送按钮
        document.getElementById('moodSend')?.addEventListener('click', () => {
            this.saveMood();
        });
        
        // 小窝照片
        document.getElementById('homePhoto')?.addEventListener('click', () => {
            document.getElementById('homeFile').click();
        });
        
        document.getElementById('homeFile')?.addEventListener('change', (e) => {
            this.handleHomePhoto(e);
        });
        
        // 删除小窝照片
        document.getElementById('homePhotoDelete')?.addEventListener('click', (e) => {
            e.stopPropagation();
            this.deleteHomePhoto();
        });
        
        // 倒计时
        document.getElementById('nextDate')?.addEventListener('change', (e) => {
            this.updateCountdown(e.target.value);
        });
        
        // 照片流
        document.getElementById('photoAdd')?.addEventListener('click', () => {
            document.getElementById('photoFile').click();
        });
        
        document.getElementById('photoFile')?.addEventListener('change', (e) => {
            this.handlePhotos(e);
        });
        
        
        // 查看器
        document.getElementById('viewerClose')?.addEventListener('click', () => {
            document.getElementById('photoViewer').classList.add('hidden');
        });
        
        // 设置
        document.getElementById('settingsBtn')?.addEventListener('click', () => {
            document.getElementById('settingsPanel').classList.remove('hidden');
        });
        
        document.getElementById('closeSettings')?.addEventListener('click', () => {
            document.getElementById('settingsPanel').classList.add('hidden');
        });
        
        document.getElementById('clearBtn')?.addEventListener('click', () => {
            this.clearData();
        });
    }
    
    // 检查认证
    checkAuth() {
        const isAuth = localStorage.getItem(this.config.storageKey + 'auth');
        
        if (isAuth === 'true') {
            // 已认证，直接进入
            this.enterTimeRiver();
        } else {
            // 显示认证
            document.getElementById('auth').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('authCode').focus();
            }, 100);
        }
    }
    
    // 处理认证
    handleAuth(e) {
        const code = e.target.value;
        
        if (code.length === 4) {
            if (code === this.preset.password) {
                // 认证成功
                localStorage.setItem(this.config.storageKey + 'auth', 'true');
                
                // 淡出动画
                const authEl = document.getElementById('auth');
                authEl.style.animation = 'dawnFadeOut 0.5s ease forwards';
                
                setTimeout(() => {
                    authEl.classList.add('hidden');
                    this.enterTimeRiver();
                }, 500);
            } else {
                // 错误反馈
                e.target.style.animation = 'shake 0.5s ease';
                setTimeout(() => {
                    e.target.style.animation = '';
                    e.target.value = '';
                }, 500);
            }
        }
    }
    
    // 进入时光河流
    enterTimeRiver() {
        // 显示主界面
        document.getElementById('timeRiver').classList.remove('hidden');
        
        // 初始化数据
        this.initializeData();
        
        // 加载已有数据
        this.loadData();
        
        // 开始动画
        this.startAnimations();
    }
    
    // 初始化数据
    initializeData() {
        // 检查是否首次使用
        const setup = localStorage.getItem(this.config.storageKey + 'setup');
        
        if (!setup) {
            // 首次使用，保存预设信息
            const setupData = {
                name1: this.preset.name1,
                name2: this.preset.name2,
                anniversary: this.preset.anniversary
            };
            localStorage.setItem(this.config.storageKey + 'setup', JSON.stringify(setupData));
        }
        
        // 更新显示
        const data = JSON.parse(localStorage.getItem(this.config.storageKey + 'setup'));
        document.getElementById('name1').textContent = data.name1;
        document.getElementById('name2').textContent = data.name2;
        
        // 计算天数
        const days = this.calculateDays(data.anniversary);
        document.getElementById('dayCount').textContent = days;
        
        // 更新起始日期
        const date = new Date(data.anniversary);
        const dateStr = `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
        document.getElementById('originDate').textContent = dateStr;
    }
    
    // 计算天数
    calculateDays(anniversary) {
        const start = new Date(anniversary);
        const now = new Date();
        const diff = now - start;
        return Math.floor(diff / (1000 * 60 * 60 * 24));
    }
    
    // 加载数据
    async loadData() {
        // 加载小窝照片
        const homeImage = localStorage.getItem(this.config.storageKey + 'homeImage');
        if (homeImage) {
            const img = document.getElementById('homeImg');
            const hint = document.querySelector('.photo-hint');
            const deleteBtn = document.getElementById('homePhotoDelete');
            
            img.src = homeImage;
            img.classList.remove('hidden');
            hint.style.display = 'none';
            deleteBtn.classList.remove('hidden');
        }
        
        // 加载倒计时
        const nextDate = localStorage.getItem(this.config.storageKey + 'nextDate');
        if (nextDate) {
            document.getElementById('nextDate').value = nextDate;
            this.updateCountdown(nextDate);
        } else {
            // 设置默认消息
            const messageEl = document.getElementById('meetingMessage');
            if (messageEl) {
                messageEl.querySelector('.message-text').textContent = '选择期待的日子，开始甜蜜倒计时';
            }
        }
        
        // 加载心情
        await this.loadMoods();
        
        // 加载照片
        await this.loadPhotos();
        
        // 加载每日语录
        this.updateDailyQuote();
    }
    
    // 更新每日语录
    updateDailyQuote() {
        const quotes = [
            '家是有你的地方',
            '阳光因你而灿烂',
            '时光因你而温柔',
            '每一天都是礼物',
            '爱是最美的风景',
            '你是我的小幸运',
            '陪伴是最长情的告白',
            '有你的地方就是家',
            '最美的时光是现在',
            '爱让平凡变得特别'
        ];
        
        const today = new Date().getDate();
        const quote = quotes[today % quotes.length];
        document.getElementById('dailyQuote').textContent = quote;
    }
    
    // 处理小窝照片
    handleHomePhoto(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            const dataUrl = event.target.result;
            
            // 保存到localStorage
            localStorage.setItem(this.config.storageKey + 'homeImage', dataUrl);
            
            // 更新显示
            const img = document.getElementById('homeImg');
            const hint = document.querySelector('.photo-hint');
            const deleteBtn = document.getElementById('homePhotoDelete');
            
            img.src = dataUrl;
            img.classList.remove('hidden');
            hint.style.display = 'none';
            deleteBtn.classList.remove('hidden');
            
            // 清空文件输入，允许重新选择同一文件
            e.target.value = '';
            
            // 动画效果
            this.showFeedback('照片已更新');
        };
        reader.readAsDataURL(file);
    }
    
    // 删除小窝照片
    deleteHomePhoto() {
        // 删除localStorage中的图片
        localStorage.removeItem(this.config.storageKey + 'homeImage');
        
        // 重置UI
        const img = document.getElementById('homeImg');
        const hint = document.querySelector('.photo-hint');
        const deleteBtn = document.getElementById('homePhotoDelete');
        
        img.classList.add('hidden');
        img.src = '';
        hint.style.display = 'flex';
        deleteBtn.classList.add('hidden');
        
        this.showFeedback('照片已删除');
    }
    
    // 更新倒计时
    updateCountdown(date) {
        if (!date) return;
        
        localStorage.setItem(this.config.storageKey + 'nextDate', date);
        
        const target = new Date(date);
        const now = new Date();
        const diff = target - now;
        const messageEl = document.getElementById('meetingMessage');
        
        if (diff > 0) {
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            document.getElementById('countDays').textContent = days;
            
            // 更新期待消息
            const messages = [
                '每一天的等待都值得',
                '期待与你重逢的时刻',
                '倒数见面的美好日子',
                '想念在每个日夜蔓延',
                '距离让思念更珍贵'
            ];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            messageEl.querySelector('.message-text').textContent = randomMessage;
        } else if (diff > -86400000) { // 当天或前一天
            document.getElementById('countDays').textContent = '0';
            messageEl.querySelector('.message-text').textContent = '今天就是见面的日子！';
        } else {
            document.getElementById('countDays').textContent = '0';
            messageEl.querySelector('.message-text').textContent = '选择下次见面的日子吧';
        }
    }
    
    // 心情水滴动画
    animateMoodDrop(element) {
        // 创建涟漪
        const ripple = document.createElement('div');
        ripple.style.cssText = `
            position: absolute;
            width: 100px;
            height: 100px;
            border: 2px solid rgba(135, 206, 235, 0.5);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: rippleExpand 1s ease;
            pointer-events: none;
        `;
        
        document.getElementById('moodRipples').appendChild(ripple);
        
        setTimeout(() => {
            ripple.remove();
        }, 1000);
    }
    
    // 保存心情
    async saveMood() {
        const text = document.getElementById('moodText').value.trim();
        if (!text && !this.currentMood) return;
        
        const mood = {
            emoji: this.getMoodEmoji(this.currentMood),
            text: text,
            date: new Date().toISOString()
        };
        
        // 保存到数据库
        if (this.db) {
            const transaction = this.db.transaction(['moods'], 'readwrite');
            const store = transaction.objectStore('moods');
            await store.add(mood);
        }
        
        // 清空输入
        document.getElementById('moodText').value = '';
        this.currentMood = null;
        
        // 重置心情按钮状态
        document.querySelectorAll('.mood-drop').forEach(btn => {
            btn.style.transform = '';
            btn.style.boxShadow = '';
        });
        
        // 更新显示
        this.loadMoods();
        this.showFeedback('心情已记录');
    }
    
    // 获取心情表情
    getMoodEmoji(mood) {
        const emojis = {
            happy: '😊',
            love: '💙',
            miss: '🌙',
            sunny: '☀️',
            hug: '🤗'
        };
        return emojis[mood] || '💭';
    }
    
    // 加载心情
    async loadMoods() {
        if (!this.db) return;
        
        const transaction = this.db.transaction(['moods'], 'readonly');
        const store = transaction.objectStore('moods');
        const request = store.getAll();
        
        request.onsuccess = (event) => {
            const moods = event.target.result;
            const container = document.getElementById('moodRipples');
            
            // 显示最近3条
            const recent = moods.slice(-3);
            recent.forEach((mood, index) => {
                setTimeout(() => {
                    this.showMoodRipple(mood);
                }, index * 500);
            });
        };
    }
    
    // 显示心情涟漪
    showMoodRipple(mood) {
        const ripple = document.createElement('div');
        ripple.style.cssText = `
            position: absolute;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            font-size: 12px;
            top: ${50 + Math.random() * 30 - 15}%;
            left: ${50 + Math.random() * 30 - 15}%;
            transform: translate(-50%, -50%);
            animation: fadeInOut 3s ease;
            pointer-events: none;
        `;
        ripple.textContent = mood.emoji + ' ' + mood.text;
        
        document.getElementById('moodRipples').appendChild(ripple);
        
        setTimeout(() => {
            ripple.remove();
        }, 3000);
    }
    
    // 处理照片上传
    async handlePhotos(e) {
        const files = Array.from(e.target.files);
        
        for (let file of files) {
            if (file.size > this.config.maxPhotoSize) {
                this.showFeedback('照片太大，需要压缩');
                await this.compressAndSavePhoto(file);
            } else {
                await this.savePhoto(file);
            }
        }
        
        this.loadPhotos();
        this.showFeedback(`已添加 ${files.length} 张照片`);
    }
    
    // 压缩并保存照片
    async compressAndSavePhoto(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxWidth = 800;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        const compressedFile = new File([blob], file.name, {
                            type: 'image/jpeg'
                        });
                        this.savePhoto(compressedFile).then(resolve);
                    }, 'image/jpeg', 0.85);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }
    
    // 保存照片
    async savePhoto(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const photo = {
                    data: e.target.result,
                    name: file.name,
                    date: new Date().toISOString()
                };
                
                const transaction = this.db.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                await store.add(photo);
                resolve();
            };
            reader.readAsDataURL(file);
        });
    }
    
    // 加载照片
    async loadPhotos() {
        if (!this.db) return;
        
        const transaction = this.db.transaction(['photos'], 'readonly');
        const store = transaction.objectStore('photos');
        const request = store.getAll();
        
        request.onsuccess = (event) => {
            const photos = event.target.result;
            const grid = document.getElementById('photoStream');
            
            // 清空网格
            grid.innerHTML = '';
            
            // 添加照片
            photos.forEach(photo => {
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="${photo.data}" alt="${photo.name}">
                    <button class="photo-delete" onclick="event.stopPropagation(); timeFlowInstance.deletePhoto(${photo.id})">×</button>
                `;
                item.onclick = () => this.viewPhoto(photo.data);
                grid.appendChild(item);
            });
        };
    }
    
    // 删除照片
    async deletePhoto(photoId) {
        if (!this.db) return;
        
        if (confirm('确定要删除这张照片吗？')) {
            const transaction = this.db.transaction(['photos'], 'readwrite');
            const store = transaction.objectStore('photos');
            await store.delete(photoId);
            
            // 重新加载照片流
            this.loadPhotos();
            this.showFeedback('照片已删除');
        }
    }
    
    // 查看照片
    viewPhoto(src) {
        const viewer = document.getElementById('photoViewer');
        const img = document.getElementById('viewerImg');
        img.src = src;
        viewer.classList.remove('hidden');
    }
    
    // 发送拥抱
    sendHug() {
        const wave = document.getElementById('hugWave');
        wave.classList.remove('hidden');
        
        // 震动反馈
        if (navigator.vibrate) {
            navigator.vibrate(200);
        }
        
        setTimeout(() => {
            wave.classList.add('hidden');
        }, 1500);
        
        this.showFeedback('温暖的拥抱已送达');
    }
    
    // 显示反馈
    showFeedback(message) {
        const feedback = document.createElement('div');
        feedback.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            color: #4A90E2;
            padding: 16px 32px;
            border-radius: 20px;
            font-size: 14px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            animation: fadeInOut 2s ease;
        `;
        feedback.textContent = message;
        
        document.body.appendChild(feedback);
        
        setTimeout(() => {
            document.body.removeChild(feedback);
        }, 2000);
    }
    
    // 初始化数据同步功能
    initDataSync() {
        // 添加同步按钮
        this.addSyncButtons();
        
        // 检查URL参数中的共享数据
        this.checkSharedData();
    }
    
    // 添加同步按钮
    addSyncButtons() {
        // 创建浮动按钮
        const syncBtn = document.createElement('button');
        syncBtn.innerHTML = '🔄';
        syncBtn.title = '数据同步';
        syncBtn.style.cssText = `
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            transition: transform 0.3s;
        `;
        
        syncBtn.onmouseover = () => {
            syncBtn.style.transform = 'scale(1.1)';
        };
        
        syncBtn.onmouseout = () => {
            syncBtn.style.transform = 'scale(1)';
        };
        
        syncBtn.onclick = () => this.showSyncMenu();
        
        document.body.appendChild(syncBtn);
    }
    
    // 显示同步菜单
    showSyncMenu() {
        const modal = document.createElement('div');
        modal.className = 'sync-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
        `;
        
        content.innerHTML = `
            <h2 style="color: #4A90E2; margin-bottom: 20px; text-align: center;">📱 数据同步</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px; text-align: center;">
                让另一半也能看到你的照片和心情 💕
            </p>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button id="exportDataBtn" style="
                    padding: 15px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 15px;
                    cursor: pointer;
                    font-size: 16px;
                    transition: opacity 0.3s;
                " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    📥 导出数据文件
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.9;">
                        保存所有照片和心情到文件
                    </div>
                </button>
                
                <button id="importDataBtn" style="
                    padding: 15px;
                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                    color: white;
                    border: none;
                    border-radius: 15px;
                    cursor: pointer;
                    font-size: 16px;
                    transition: opacity 0.3s;
                " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    📤 导入数据文件
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.9;">
                        从另一半发来的文件同步数据
                    </div>
                </button>
                
                <hr style="border: none; border-top: 1px solid #eee; margin: 10px 0;">
                
                <button id="closeSyncBtn" style="
                    padding: 12px;
                    background: #f0f0f0;
                    color: #666;
                    border: none;
                    border-radius: 15px;
                    cursor: pointer;
                    font-size: 14px;
                ">取消</button>
            </div>
        `;
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // 绑定事件
        document.getElementById('exportDataBtn').onclick = () => {
            this.exportData();
            modal.remove();
        };
        
        document.getElementById('importDataBtn').onclick = () => {
            this.importData();
            modal.remove();
        };
        
        document.getElementById('closeSyncBtn').onclick = () => {
            modal.remove();
        };
        
        // 点击背景关闭
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        };
    }
    
    // 导出数据
    async exportData() {
        try {
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                exportBy: localStorage.getItem(this.config.storageKey + 'name1') || this.preset.name1,
                config: {
                    name1: localStorage.getItem(this.config.storageKey + 'name1') || this.preset.name1,
                    name2: localStorage.getItem(this.config.storageKey + 'name2') || this.preset.name2,
                    anniversary: localStorage.getItem(this.config.storageKey + 'anniversary') || this.preset.anniversary,
                    homeImage: localStorage.getItem(this.config.storageKey + 'homeImage'),
                    nextDate: localStorage.getItem(this.config.storageKey + 'nextDate')
                },
                photos: [],
                moods: []
            };
            
            // 导出照片
            if (this.db) {
                const photosTransaction = this.db.transaction(['photos'], 'readonly');
                const photosStore = photosTransaction.objectStore('photos');
                const photosRequest = photosStore.getAll();
                
                await new Promise((resolve) => {
                    photosRequest.onsuccess = (event) => {
                        data.photos = event.target.result;
                        resolve();
                    };
                });
                
                // 导出心情
                const moodsTransaction = this.db.transaction(['moods'], 'readonly');
                const moodsStore = moodsTransaction.objectStore('moods');
                const moodsRequest = moodsStore.getAll();
                
                await new Promise((resolve) => {
                    moodsRequest.onsuccess = (event) => {
                        data.moods = event.target.result;
                        resolve();
                    };
                });
            }
            
            // 生成文件名
            const date = new Date().toISOString().split('T')[0];
            const filename = `时光纽带-${date}.json`;
            
            // 创建下载链接
            const json = JSON.stringify(data);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            this.showFeedback(`数据已导出！发送 ${filename} 给另一半即可同步`);
        } catch (error) {
            console.error('导出失败:', error);
            this.showFeedback('导出失败，请重试');
        }
    }
    
    // 导入数据
    async importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // 验证数据格式
                if (!data.version || !data.config) {
                    throw new Error('无效的数据文件');
                }
                
                // 显示导入预览
                const confirmMsg = `
确认导入来自 ${data.exportBy || '未知'} 的数据？
导出时间：${new Date(data.exportDate).toLocaleString('zh-CN')}
包含：${data.photos.length} 张照片，${data.moods.length} 条心情

注意：导入将合并数据，不会删除现有内容`;
                
                if (!confirm(confirmMsg)) return;
                
                // 导入配置（可选）
                const importConfig = confirm('是否同时导入配置信息（姓名、纪念日等）？');
                if (importConfig && data.config) {
                    if (data.config.name1) localStorage.setItem(this.config.storageKey + 'name1', data.config.name1);
                    if (data.config.name2) localStorage.setItem(this.config.storageKey + 'name2', data.config.name2);
                    if (data.config.anniversary) localStorage.setItem(this.config.storageKey + 'anniversary', data.config.anniversary);
                    if (data.config.homeImage) localStorage.setItem(this.config.storageKey + 'homeImage', data.config.homeImage);
                    if (data.config.nextDate) localStorage.setItem(this.config.storageKey + 'nextDate', data.config.nextDate);
                }
                
                // 导入照片和心情
                let importedPhotos = 0;
                let importedMoods = 0;
                
                if (this.db) {
                    // 导入照片（避免重复）
                    if (data.photos && data.photos.length > 0) {
                        const photosTransaction = this.db.transaction(['photos'], 'readwrite');
                        const photosStore = photosTransaction.objectStore('photos');
                        
                        for (let photo of data.photos) {
                            try {
                                await photosStore.add(photo);
                                importedPhotos++;
                            } catch (e) {
                                // 忽略重复的照片
                                console.log('跳过重复照片');
                            }
                        }
                    }
                    
                    // 导入心情（避免重复）
                    if (data.moods && data.moods.length > 0) {
                        const moodsTransaction = this.db.transaction(['moods'], 'readwrite');
                        const moodsStore = moodsTransaction.objectStore('moods');
                        
                        for (let mood of data.moods) {
                            try {
                                await moodsStore.add(mood);
                                importedMoods++;
                            } catch (e) {
                                // 忽略重复的心情
                                console.log('跳过重复心情');
                            }
                        }
                    }
                }
                
                this.showFeedback(`成功导入 ${importedPhotos} 张照片，${importedMoods} 条心情！`);
                
                // 刷新显示
                setTimeout(() => {
                    this.loadPhotos();
                    this.loadMoods();
                    if (importConfig) {
                        location.reload();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('导入失败:', error);
                this.showFeedback('导入失败：' + error.message);
            }
        };
        
        input.click();
    }
    
    // 检查URL中的共享数据
    checkSharedData() {
        // 预留功能：未来可通过URL参数快速共享配置
    }
    
    // 初始化滚动效果
    initScrollEffects() {
        const contentFlow = document.getElementById('contentFlow');
        if (!contentFlow) return;
        
        // 监听滚动
        let lastScrollTop = 0;
        window.addEventListener('scroll', () => {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const maxScroll = document.documentElement.scrollHeight - window.innerHeight;
            const scrollPercent = scrollTop / maxScroll;
            
            // 更新天空渐变
            this.updateSkyGradient(scrollPercent);
            
            // 视差效果
            this.updateParallax(scrollTop);
            
            lastScrollTop = scrollTop;
        });
    }
    
    // 更新天空渐变
    updateSkyGradient(percent) {
        const layers = document.querySelectorAll('.sky-layer');
        
        // 根据滚动位置显示不同的天空
        layers.forEach((layer, index) => {
            const start = index * 0.25;
            const end = (index + 1) * 0.25;
            
            if (percent >= start && percent <= end) {
                layer.style.opacity = '1';
            } else if (percent > end) {
                layer.style.opacity = '0';
            }
        });
    }
    
    // 更新视差效果
    updateParallax(scrollTop) {
        // 光流效果
        document.querySelectorAll('.light-stream').forEach((stream, index) => {
            const speed = 0.5 + index * 0.1;
            stream.style.transform = `translateX(${scrollTop * speed}px)`;
        });
        
        // 内容淡入
        document.querySelectorAll('.flow-section').forEach(section => {
            const rect = section.getBoundingClientRect();
            const windowHeight = window.innerHeight;
            
            if (rect.top < windowHeight * 0.8 && rect.bottom > 0) {
                section.style.opacity = '1';
                section.style.transform = 'translateY(0)';
            }
        });
    }
    
    // 开始动画
    startAnimations() {
        // 初始化所有section的状态
        document.querySelectorAll('.flow-section').forEach(section => {
            section.style.opacity = '0';
            section.style.transform = 'translateY(20px)';
            section.style.transition = 'all 0.8s ease';
        });
        
        // 触发初始滚动检查
        window.dispatchEvent(new Event('scroll'));
    }
    
    // 清除数据
    clearData() {
        if (confirm('确定要清除所有数据吗？这将删除所有照片和记录。')) {
            // 清除localStorage
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith(this.config.storageKey)) {
                    localStorage.removeItem(key);
                }
            });
            
            // 清除IndexedDB
            if (this.db) {
                const transaction = this.db.transaction(['photos', 'moods'], 'readwrite');
                transaction.objectStore('photos').clear();
                transaction.objectStore('moods').clear();
            }
            
            // 重新加载页面
            location.reload();
        }
    }
}

// 添加必要的CSS动画
const style = document.createElement('style');
style.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    @keyframes fadeInOut {
        0% { opacity: 0; transform: scale(0.9); }
        50% { opacity: 1; transform: scale(1); }
        100% { opacity: 0; transform: scale(0.9); }
    }
    
    @keyframes rippleExpand {
        from {
            width: 0;
            height: 0;
            opacity: 1;
        }
        to {
            width: 200px;
            height: 200px;
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);

// 启动应用
document.addEventListener('DOMContentLoaded', () => {
    new TimeFlow();
});
    </script>
    
    <script>
    
// ==== 自包含页面增强功能 ====
(function() {
    // 页面数据存储
    const embeddedData = {
        photos: [],
        moods: [],
        config: {}
    };
    
    // 初始化嵌入数据
    function loadEmbeddedData() {
        // 从隐藏元素加载已保存的照片
        const savedPhotosEl = document.getElementById('embeddedPhotosData');
        if (savedPhotosEl) {
            savedPhotosEl.querySelectorAll('img').forEach(img => {
                embeddedData.photos.push({
                    data: img.src,
                    id: img.dataset.id || Date.now() + Math.random()
                });
            });
        }
        
        // 从隐藏元素加载心情
        const savedMoodsEl = document.getElementById('embeddedMoodsData');
        if (savedMoodsEl && savedMoodsEl.textContent) {
            try {
                embeddedData.moods = JSON.parse(savedMoodsEl.textContent);
            } catch(e) {}
        }
        
        // 显示已保存的数据
        setTimeout(() => {
            displayEmbeddedPhotos();
            displayEmbeddedMoods();
        }, 3500); // 在开场动画后显示
    }
    
    // 显示嵌入的照片
    function displayEmbeddedPhotos() {
        const photoStream = document.getElementById('photoStream');
        if (!photoStream || embeddedData.photos.length === 0) return;
        
        // 添加到现有照片流
        embeddedData.photos.forEach(photo => {
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            photoItem.innerHTML = `
                <div class="photo-glow"></div>
                <img src="${photo.data}" alt="照片">
                <button class="photo-delete" onclick="removeEmbeddedPhoto('${photo.id}')">&times;</button>
            `;
            photoStream.appendChild(photoItem);
        });
    }
    
    // 显示嵌入的心情  
    function displayEmbeddedMoods() {
        const moodRipples = document.getElementById('moodRipples');
        if (!moodRipples || embeddedData.moods.length === 0) return;
        
        embeddedData.moods.forEach(mood => {
            const ripple = document.createElement('div');
            ripple.className = 'mood-ripple-saved';
            ripple.innerHTML = `<span>${mood.emoji}</span><span>${mood.text}</span>`;
            moodRipples.appendChild(ripple);
        });
    }
    
    // 劫持原有函数
    function hijackOriginalFunctions() {
        const checkInterval = setInterval(() => {
            if (window.timeFlowInstance) {
                clearInterval(checkInterval);
                
                // 劫持照片处理
                const original_handlePhotos = window.timeFlowInstance.handlePhotos;
                window.timeFlowInstance.handlePhotos = async function(e) {
                    const files = Array.from(e.target.files);
                    
                    for (let file of files) {
                        // 读取为base64
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const photoData = {
                                data: e.target.result,
                                id: Date.now() + '_' + Math.random()
                            };
                            embeddedData.photos.push(photoData);
                            
                            // 添加到页面
                            const photoStream = document.getElementById('photoStream');
                            const photoItem = document.createElement('div');
                            photoItem.className = 'photo-item';
                            photoItem.innerHTML = `
                                <div class="photo-glow"></div>
                                <img src="${photoData.data}" alt="照片">
                                <button class="photo-delete" onclick="removeEmbeddedPhoto('${photoData.id}')">&times;</button>
                            `;
                            photoStream.appendChild(photoItem);
                            
                            // 显示保存按钮
                            showSaveButton();
                        };
                        reader.readAsDataURL(file);
                    }
                    
                    // 调用原函数的其他效果
                    if (this.showFeedback) {
                        this.showFeedback('照片已添加');
                    }
                };
                
                // 劫持心情发送
                const original_sendMood = window.timeFlowInstance.sendMood;
                window.timeFlowInstance.sendMood = function() {
                    const moodText = document.getElementById('moodText');
                    if (moodText && moodText.value) {
                        embeddedData.moods.push({
                            text: moodText.value,
                            emoji: this.currentMood || '💭',
                            time: new Date().toISOString()
                        });
                        showSaveButton();
                    }
                    
                    // 调用原函数
                    if (original_sendMood) {
                        original_sendMood.call(this);
                    }
                };
            }
        }, 100);
    }
    
    // 删除嵌入的照片
    window.removeEmbeddedPhoto = function(photoId) {
        embeddedData.photos = embeddedData.photos.filter(p => p.id !== photoId);
        showSaveButton();
    };
    
    // 显示保存按钮
    function showSaveButton() {
        let btn = document.getElementById('savePageBtn');
        if (!btn) {
            btn = document.createElement('button');
            btn.id = 'savePageBtn';
            btn.innerHTML = '💾 保存页面';
            btn.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                z-index: 10000;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 15px 30px;
                border-radius: 30px;
                font-size: 16px;
                cursor: pointer;
                box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
                animation: pulse 2s infinite;
            `;
            btn.onclick = savePage;
            document.body.appendChild(btn);
        }
        
        // 动画提示
        btn.style.animation = 'pulse 0.5s';
        setTimeout(() => {
            btn.style.animation = 'pulse 2s infinite';
        }, 500);
    }
    
    // 保存页面
    function savePage() {
        // 获取当前完整HTML
        let currentHTML = document.documentElement.outerHTML;
        
        // 更新嵌入的数据
        const photosHTML = embeddedData.photos.map(p => 
            `<img src="${p.data}" data-id="${p.id}" style="display:none;">`
        ).join('');
        
        const moodsJSON = JSON.stringify(embeddedData.moods);
        
        // 替换数据存储区
        currentHTML = currentHTML.replace(
            /<div id="embeddedPhotosData"[^>]*>.*?<\/div>/s,
            `<div id="embeddedPhotosData" style="display:none;">${photosHTML}</div>`
        );
        
        currentHTML = currentHTML.replace(
            /<div id="embeddedMoodsData"[^>]*>.*?<\/div>/s,
            `<div id="embeddedMoodsData" style="display:none;">${moodsJSON}</div>`
        );
        
        // 创建下载
        const blob = new Blob([currentHTML], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `时光纽带_${new Date().toISOString().split('T')[0]}.html`;
        a.click();
        URL.revokeObjectURL(url);
        
        // 提示
        if (window.timeFlowInstance && window.timeFlowInstance.showFeedback) {
            window.timeFlowInstance.showFeedback('页面已保存');
        }
    }
    
    // 添加保存按钮动画
    const saveButtonStyle = document.createElement('style');
    saveButtonStyle.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .mood-ripple-saved {
            position: absolute;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            animation: float 20s infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0) translateX(0); }
            50% { transform: translateY(-20px) translateX(10px); }
            100% { transform: translateY(0) translateX(0); }
        }
    `;
    document.head.appendChild(saveButtonStyle);
    
    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
        loadEmbeddedData();
        hijackOriginalFunctions();
    });
})();

    </script>
    
</body>
</html>