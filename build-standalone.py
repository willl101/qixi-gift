#!/usr/bin/env python3
import base64

# ËØªÂèñÂøÖË¶ÅÊñá‰ª∂
with open('index.html', 'r', encoding='utf-8') as f:
    html_content = f.read()

with open('styles.css', 'r', encoding='utf-8') as f:
    css_content = f.read()

with open('app.js', 'r', encoding='utf-8') as f:
    js_content = f.read()

# Â¢ûÂº∫ÁöÑJavaScript‰ª£Á†Å
enhanced_js = """
// ==== Ëá™ÂåÖÂê´È°µÈù¢Â¢ûÂº∫ÂäüËÉΩ ====
(function() {
    // È°µÈù¢Êï∞ÊçÆÂ≠òÂÇ®
    const embeddedData = {
        photos: [],
        moods: [],
        config: {}
    };
    
    // ÂàùÂßãÂåñÂµåÂÖ•Êï∞ÊçÆ
    function loadEmbeddedData() {
        // ‰ªéÈöêËóèÂÖÉÁ¥†Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑÁÖßÁâá
        const savedPhotosEl = document.getElementById('embeddedPhotosData');
        if (savedPhotosEl) {
            savedPhotosEl.querySelectorAll('img').forEach(img => {
                embeddedData.photos.push({
                    data: img.src,
                    id: img.dataset.id || Date.now() + Math.random()
                });
            });
        }
        
        // ‰ªéÈöêËóèÂÖÉÁ¥†Âä†ËΩΩÂøÉÊÉÖ
        const savedMoodsEl = document.getElementById('embeddedMoodsData');
        if (savedMoodsEl && savedMoodsEl.textContent) {
            try {
                embeddedData.moods = JSON.parse(savedMoodsEl.textContent);
            } catch(e) {}
        }
        
        // ÊòæÁ§∫Â∑≤‰øùÂ≠òÁöÑÊï∞ÊçÆ
        setTimeout(() => {
            displayEmbeddedPhotos();
            displayEmbeddedMoods();
        }, 3500); // Âú®ÂºÄÂú∫Âä®ÁîªÂêéÊòæÁ§∫
    }
    
    // ÊòæÁ§∫ÂµåÂÖ•ÁöÑÁÖßÁâá
    function displayEmbeddedPhotos() {
        const photoStream = document.getElementById('photoStream');
        if (!photoStream || embeddedData.photos.length === 0) return;
        
        // Ê∑ªÂä†Âà∞Áé∞ÊúâÁÖßÁâáÊµÅ
        embeddedData.photos.forEach(photo => {
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            photoItem.innerHTML = `
                <div class="photo-glow"></div>
                <img src="${photo.data}" alt="ÁÖßÁâá">
                <button class="photo-delete" onclick="removeEmbeddedPhoto('${photo.id}')">&times;</button>
            `;
            photoStream.appendChild(photoItem);
        });
    }
    
    // ÊòæÁ§∫ÂµåÂÖ•ÁöÑÂøÉÊÉÖ  
    function displayEmbeddedMoods() {
        const moodRipples = document.getElementById('moodRipples');
        if (!moodRipples || embeddedData.moods.length === 0) return;
        
        embeddedData.moods.forEach(mood => {
            const ripple = document.createElement('div');
            ripple.className = 'mood-ripple-saved';
            ripple.innerHTML = `<span>${mood.emoji}</span><span>${mood.text}</span>`;
            moodRipples.appendChild(ripple);
        });
    }
    
    // Âä´ÊåÅÂéüÊúâÂáΩÊï∞
    function hijackOriginalFunctions() {
        const checkInterval = setInterval(() => {
            if (window.timeFlowInstance) {
                clearInterval(checkInterval);
                
                // Âä´ÊåÅÁÖßÁâáÂ§ÑÁêÜ
                const original_handlePhotos = window.timeFlowInstance.handlePhotos;
                window.timeFlowInstance.handlePhotos = async function(e) {
                    const files = Array.from(e.target.files);
                    
                    for (let file of files) {
                        // ËØªÂèñ‰∏∫base64
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const photoData = {
                                data: e.target.result,
                                id: Date.now() + '_' + Math.random()
                            };
                            embeddedData.photos.push(photoData);
                            
                            // Ê∑ªÂä†Âà∞È°µÈù¢
                            const photoStream = document.getElementById('photoStream');
                            const photoItem = document.createElement('div');
                            photoItem.className = 'photo-item';
                            photoItem.innerHTML = `
                                <div class="photo-glow"></div>
                                <img src="${photoData.data}" alt="ÁÖßÁâá">
                                <button class="photo-delete" onclick="removeEmbeddedPhoto('${photoData.id}')">&times;</button>
                            `;
                            photoStream.appendChild(photoItem);
                            
                            // ÊòæÁ§∫‰øùÂ≠òÊåâÈíÆ
                            showSaveButton();
                        };
                        reader.readAsDataURL(file);
                    }
                    
                    // Ë∞ÉÁî®ÂéüÂáΩÊï∞ÁöÑÂÖ∂‰ªñÊïàÊûú
                    if (this.showFeedback) {
                        this.showFeedback('ÁÖßÁâáÂ∑≤Ê∑ªÂä†');
                    }
                };
                
                // Âä´ÊåÅÂøÉÊÉÖÂèëÈÄÅ
                const original_sendMood = window.timeFlowInstance.sendMood;
                window.timeFlowInstance.sendMood = function() {
                    const moodText = document.getElementById('moodText');
                    if (moodText && moodText.value) {
                        embeddedData.moods.push({
                            text: moodText.value,
                            emoji: this.currentMood || 'üí≠',
                            time: new Date().toISOString()
                        });
                        showSaveButton();
                    }
                    
                    // Ë∞ÉÁî®ÂéüÂáΩÊï∞
                    if (original_sendMood) {
                        original_sendMood.call(this);
                    }
                };
            }
        }, 100);
    }
    
    // Âà†Èô§ÂµåÂÖ•ÁöÑÁÖßÁâá
    window.removeEmbeddedPhoto = function(photoId) {
        embeddedData.photos = embeddedData.photos.filter(p => p.id !== photoId);
        showSaveButton();
    };
    
    // ÊòæÁ§∫‰øùÂ≠òÊåâÈíÆ
    function showSaveButton() {
        let btn = document.getElementById('savePageBtn');
        if (!btn) {
            btn = document.createElement('button');
            btn.id = 'savePageBtn';
            btn.innerHTML = 'üíæ ‰øùÂ≠òÈ°µÈù¢';
            btn.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                z-index: 10000;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 15px 30px;
                border-radius: 30px;
                font-size: 16px;
                cursor: pointer;
                box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
                animation: pulse 2s infinite;
            `;
            btn.onclick = savePage;
            document.body.appendChild(btn);
        }
        
        // Âä®ÁîªÊèêÁ§∫
        btn.style.animation = 'pulse 0.5s';
        setTimeout(() => {
            btn.style.animation = 'pulse 2s infinite';
        }, 500);
    }
    
    // ‰øùÂ≠òÈ°µÈù¢
    function savePage() {
        // Ëé∑ÂèñÂΩìÂâçÂÆåÊï¥HTML
        let currentHTML = document.documentElement.outerHTML;
        
        // Êõ¥Êñ∞ÂµåÂÖ•ÁöÑÊï∞ÊçÆ
        const photosHTML = embeddedData.photos.map(p => 
            `<img src="${p.data}" data-id="${p.id}" style="display:none;">`
        ).join('');
        
        const moodsJSON = JSON.stringify(embeddedData.moods);
        
        // ÊõøÊç¢Êï∞ÊçÆÂ≠òÂÇ®Âå∫
        currentHTML = currentHTML.replace(
            /<div id="embeddedPhotosData"[^>]*>.*?<\\/div>/s,
            `<div id="embeddedPhotosData" style="display:none;">${photosHTML}</div>`
        );
        
        currentHTML = currentHTML.replace(
            /<div id="embeddedMoodsData"[^>]*>.*?<\\/div>/s,
            `<div id="embeddedMoodsData" style="display:none;">${moodsJSON}</div>`
        );
        
        // ÂàõÂª∫‰∏ãËΩΩ
        const blob = new Blob([currentHTML], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Êó∂ÂÖâÁ∫ΩÂ∏¶_${new Date().toISOString().split('T')[0]}.html`;
        a.click();
        URL.revokeObjectURL(url);
        
        // ÊèêÁ§∫
        if (window.timeFlowInstance && window.timeFlowInstance.showFeedback) {
            window.timeFlowInstance.showFeedback('È°µÈù¢Â∑≤‰øùÂ≠ò');
        }
    }
    
    // Ê∑ªÂä†‰øùÂ≠òÊåâÈíÆÂä®Áîª
    const saveButtonStyle = document.createElement('style');
    saveButtonStyle.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .mood-ripple-saved {
            position: absolute;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            animation: float 20s infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0) translateX(0); }
            50% { transform: translateY(-20px) translateX(10px); }
            100% { transform: translateY(0) translateX(0); }
        }
    `;
    document.head.appendChild(saveButtonStyle);
    
    // ÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', () => {
        loadEmbeddedData();
        hijackOriginalFunctions();
    });
})();
"""

# ÊûÑÂª∫ÂÆåÊï¥HTML
standalone_html = html_content.replace(
    '<link rel="stylesheet" href="styles.css">',
    f'<style>\n{css_content}\n</style>'
).replace(
    '<script src="app.js"></script>',
    f'''
    <!-- Êï∞ÊçÆÂ≠òÂÇ®Âå∫ -->
    <div id="embeddedPhotosData" style="display:none;"></div>
    <div id="embeddedMoodsData" style="display:none;"></div>
    
    <script>
    {js_content}
    </script>
    
    <script>
    {enhanced_js}
    </script>
    '''
)

# ÂÜôÂÖ•Êñá‰ª∂
with open('index-selfcontained.html', 'w', encoding='utf-8') as f:
    f.write(standalone_html)

print("‚úÖ Â∑≤ÂàõÂª∫ index-selfcontained.html")
print("üìÅ Êñá‰ª∂Â§ßÂ∞è:", len(standalone_html), "Â≠óËäÇ")
print("üé® ‰øùÊåÅÂéüÁâàÂÆåÂÖ®‰∏ÄÊ†∑ÁöÑÂ§ñËßÇ")
print("üíæ ÊîØÊåÅËá™Âä®‰øùÂ≠òÁÖßÁâáÂà∞HTMLÊñá‰ª∂‰∏≠")